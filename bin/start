#!/usr/bin/env node
const pm2 = require('pm2');
const ch = require('chalk');

const path = require('path');

const configExists = require('fs').existsSync(path.join(__dirname, '..', 'config', 'config.json'));

console.log('Starting cbm-registry');

if (configExists) {
    console.log('config.json found => Running in production mode');
} else {
    console.log('config.json not found => Running in development mode')
    console.log(ch.yellow('In development mode, data will get stored in-memory and lost after stopping the server.'))
    console.log('To create a config.json, please run the ./bin/setup script.');
}

pm2.connect(function (error) {
    if (error) {
        console.error(error);
        process.exit(2);
    }
    pm2.start(path.join(__dirname, 'www'), {
        name: 'cbm-registry',
        instances: configExists ? 4 : 1,
        exec_mode: 'cluster',
        env: {
            PORT: 8080,
            NODE_ENV: configExists ? 'production' : 'development'
        },
    }, (error) => {
        pm2.disconnect();
        if (error) throw error;
        else {
            console.log(`Server is running on http://localhost:${8080}.`)
        }
    });
});
